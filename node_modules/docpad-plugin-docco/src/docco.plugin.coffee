module.exports = (BasePlugin) ->
  class DoccoPlugin extends BasePlugin
    name: 'docco'
    config: {}

    render: (opts) ->
      {inExtension, outExtension, content, file} = opts

      if inExtension in ['litcoffee'] and outExtension in ['html']
        docco       = require 'docco'
        {highlight} = require 'highlight.js'
        marked      = require 'marked'
        fs          = require 'fs'

        filename = file.get('filename')
        sections = docco.parse filename, content

        format = (section) ->
          codeHtml = highlight('coffeescript', section.codeText).value
          docsHtml = marked(section.docsText)
          return '<div class="code highlight"><pre>' + codeHtml +
            '</pre></div><div class="docs">' + docsHtml + '</div>'

        opts.content = (format(s) for s in sections).join()
